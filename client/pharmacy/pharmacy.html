<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leeyana - Hospital Pharmacy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #004AAD;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 74, 173, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid #004AAD;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            background: #004AAD;
            border: none;
            font-size: 14px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 6px;
            transition: background 0.2s ease;
            font-weight: 500;
        }

        .back-button:hover {
            background: #1C7EB7;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #004AAD;
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: #48ADE7;
            font-weight: 500;
            margin-top: 2px;
        }

        .search-bar {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 45px 12px 16px;
            border: 2px solid #DDE6EE;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .search-bar input:focus {
            border-color: #48ADE7;
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #A1BCCC;
            cursor: pointer;
            font-size: 16px;
        }

        .cart-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cart-button, .request-button {
            position: relative;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background 0.2s ease;
            font-size: 14px;
        }

        .cart-button {
            background: #004AAD;
            color: white;
        }

        .request-button {
            background: #48ADE7;
            color: white;
        }

        .cart-button:hover {
            background: #1C7EB7;
        }

        .request-button:hover {
            background: #A1BCCC;
        }

        .cart-count {
            background: #dc3545;
            color: white;
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 600;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .medicine-list-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 74, 173, 0.1);
            text-align: center;
            border-left: 4px solid #004AAD;
        }

        .medicine-list-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: #004AAD;
            margin-bottom: 8px;
        }

        .medicine-list-header p {
            color: #48ADE7;
            font-size: 16px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 74, 173, 0.1);
            border-left: 4px solid #48ADE7;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 13px;
            color: #004AAD;
            font-weight: 600;
        }

        .filter-group select {
            padding: 10px 14px;
            border: 1px solid #DDE6EE;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            min-width: 160px;
            color: #004AAD;
            transition: border-color 0.2s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #48ADE7;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 74, 173, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #DDE6EE;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 74, 173, 0.15);
        }

        .product-image {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .medicine-img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 8px;
        }

        .stock-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .in-stock {
            background: #28a745;
            color: white;
        }

        .low-stock {
            background: #ffc107;
            color: #212529;
        }

        .out-of-stock {
            background: #dc3545;
            color: white;
        }

        .product-info {
            padding: 18px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 700;
            color: #004AAD;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .product-generic {
            font-size: 12px;
            color: #48ADE7;
            margin-bottom: 10px;
            font-style: italic;
        }

        .product-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #004AAD;
        }

        .product-unit {
            font-size: 11px;
            color: #A1BCCC;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .prescription-required {
            background: #ffc107;
            color: #212529;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #DDE6EE;
        }

        .quantity-btn {
            background: transparent;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #004AAD;
            transition: background 0.2s ease;
        }

        .quantity-btn:hover {
            background: #DDE6EE;
        }

        .quantity-input {
            border: none;
            background: transparent;
            padding: 8px;
            width: 50px;
            text-align: center;
            outline: none;
            font-weight: 500;
            color: #004AAD;
        }

        .add-to-cart, .buy-now {
            border: none;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
            transition: background 0.2s ease;
            font-size: 12px;
        }

        .add-to-cart {
            background: #004AAD;
            color: white;
        }

        .buy-now {
            background: #48ADE7;
            color: white;
        }

        .add-to-cart:hover {
            background: #1C7EB7;
        }

        .buy-now:hover {
            background: #A1BCCC;
        }

        .add-to-cart:disabled {
            background: #DDE6EE;
            color: #A1BCCC;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 74, 173, 0.1);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 74, 173, 0.2);
            border: 1px solid #DDE6EE;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #DDE6EE;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #004AAD;
        }

        .close {
            color: #A1BCCC;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #004AAD;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #004AAD;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #DDE6EE;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            color: #004AAD;
            outline: none;
            transition: border-color 0.2s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #48ADE7;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .submit-button {
            width: 100%;
            padding: 14px;
            background: #004AAD;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s ease;
        }

        .submit-button:hover {
            background: #1C7EB7;
        }

        .cart-modal .modal-content {
            max-width: 700px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #DDE6EE;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #DDE6EE;
        }

        .cart-item-image img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 15px;
            color: #004AAD;
        }

        .cart-item-price {
            color: #48ADE7;
            font-weight: 500;
            font-size: 13px;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .remove-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .remove-item:hover {
            background: #c82333;
        }

        .cart-summary {
            padding: 20px 0;
            border-top: 2px solid #DDE6EE;
            margin-top: 20px;
        }

        .total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #004AAD;
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .checkout-button, .cash-payment-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .checkout-button {
            background: #004AAD;
            color: white;
        }

        .cash-payment-button {
            background: #48ADE7;
            color: white;
        }

        .checkout-button:hover {
            background: #1C7EB7;
        }

        .cash-payment-button:hover {
            background: #A1BCCC;
        }

        .payment-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            color: #004AAD;
            font-size: 13px;
            font-weight: 500;
            margin-top: 12px;
            border: 1px solid #DDE6EE;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .search-bar {
                order: 3;
                max-width: 100%;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .filter-group select {
                min-width: 100%;
            }

            .modal-content {
                margin: 10% auto;
                width: 95%;
            }

            .payment-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <button class="back-button" onclick="goBack()">
                    ← Back
                </button>
                <div class="logo">
                    <div>
                        <div class="logo-text">LEEYANA PHARMACY</div>
                        <div class="logo-subtitle">Hospital Pharmacy Services</div>
                    </div>
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" placeholder="Search medicines, generic names..." id="searchInput">
                <span class="search-icon">🔍</span>
            </div>
            
            <div class="cart-section">
                <button class="request-button" onclick="openRequestModal()">
                    📋 Request Medicine
                </button>
                <button class="cart-button" onclick="openCartModal()">
                    🛒 Cart
                    <span class="cart-count" id="cartCount">0</span>
                </button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="medicine-list-header">
            <h2>Available Medicines</h2>
            <p>Comprehensive pharmaceutical inventory for hospital and patient care</p>
        </div>

        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Category</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="pain-relief">Pain Relief</option>
                        <option value="antibiotics">Antibiotics</option>
                        <option value="vitamins">Vitamins & Supplements</option>
                        <option value="diabetes">Diabetes Care</option>
                        <option value="heart">Cardiovascular</option>
                        <option value="skin">Dermatology</option>
                        <option value="respiratory">Respiratory</option>
                        <option value="digestive">Gastroenterology</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Prescription Status</label>
                    <select id="prescriptionFilter">
                        <option value="">All</option>
                        <option value="required">Prescription Required</option>
                        <option value="otc">Over the Counter</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Price Range</label>
                    <select id="priceFilter">
                        <option value="">All Prices</option>
                        <option value="0-10">$0 - $10</option>
                        <option value="10-25">$10 - $25</option>
                        <option value="25-50">$25 - $50</option>
                        <option value="50+">$50+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Availability</label>
                    <select id="stockFilter">
                        <option value="">All</option>
                        <option value="in-stock">In Stock</option>
                        <option value="low-stock">Low Stock</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
        </div>
    </div>

    <!-- Request Medicine Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Medicine Request Form</h2>
                <button class="close" onclick="closeRequestModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName">Patient Name:</label>
                            <input type="text" id="patientName" name="patientName" placeholder="Enter patient full name" required>
                        </div>
                        <div class="form-group">
                            <label for="contactNumber">Contact Number:</label>
                            <input type="tel" id="contactNumber" name="contactNumber" placeholder="Enter phone number" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="medicineName">Medicine Name:</label>
                        <input type="text" id="medicineName" name="medicineName" placeholder="Enter medicine name or brand" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dosage">Dosage/Strength:</label>
                            <input type="text" id="dosage" name="dosage" placeholder="e.g., 500mg, 10ml, 250mg/5ml" required>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity Needed:</label>
                            <input type="number" id="quantity" name="quantity" placeholder="Enter quantity" min="1" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="urgency">Urgency Level:</label>
                            <select id="urgency" name="urgency" required>
                                <option value="">Select urgency level</option>
                                <option value="routine">Routine (3-5 days)</option>
                                <option value="urgent">Urgent (1-2 days)</option>
                                <option value="emergency">Emergency (Same day)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="formType">Form Type:</label>
                            <select id="formType" name="formType">
                                <option value="">Select form type</option>
                                <option value="tablets">Tablets</option>
                                <option value="capsules">Capsules</option>
                                <option value="liquid">Liquid/Syrup</option>
                                <option value="injection">Injection</option>
                                <option value="cream">Cream/Ointment</option>
                                <option value="drops">Drops</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctorName">Prescribing Doctor:</label>
                        <input type="text" id="doctorName" name="doctorName" placeholder="Enter doctor's name (if applicable)">
                    </div>
                    
                    <div class="form-group">
                        <label for="medicalCondition">Medical Condition/Purpose:</label>
                        <textarea id="medicalCondition" name="medicalCondition" placeholder="Briefly describe the medical condition or purpose for the medicine" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientAge">Patient Age:</label>
                            <input type="number" id="patientAge" name="patientAge" placeholder="Enter patient age" min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label for="allergies">Known Allergies:</label>
                            <input type="text" id="allergies" name="allergies" placeholder="List any known drug allergies or 'None'">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalNotes">Additional Notes:</label>
                        <textarea id="additionalNotes" name="additionalNotes" placeholder="Any special instructions, preferred brands, or additional information"></textarea>
                    </div>
                    
                    <button type="submit" class="submit-button">Submit Request</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Shopping Cart</h2>
                <button class="close" onclick="closeCartModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cartItems">
                    <!-- Cart items will be loaded here -->
                </div>
                <div class="cart-summary" id="cartSummary" style="display: none;">
                    <div class="total-amount" id="totalAmount">Total: $0.00</div>
                    <div class="payment-buttons">
                        <button class="checkout-button" onclick="proceedToCheckout()">
                            Proceed to Checkout
                        </button>
                        <button class="cash-payment-button" onclick="proceedToCashPayment()">
                            Pay with Cash
                        </button>
                    </div>
                    <div class="payment-info">
                        Cash payments can be made at the pharmacy counter
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Now Modal -->
    <div id="buyNowModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Quick Purchase</h2>
                <button class="close" onclick="closeBuyNowModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="buyNowItem">
                    <!-- Buy now item details will be loaded here -->
                </div>
                <div class="payment-buttons">
                    <button class="checkout-button" onclick="confirmQuickPurchase()">
                        Confirm Purchase
                    </button>
                    <button class="cash-payment-button" onclick="confirmCashPurchase()">
                        Pay with Cash
                    </button>
                </div>
                <div class="payment-info">
                    For cash payments, please proceed to the pharmacy counter with this order number
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let medicines = [];
        let filteredMedicines = [];
        let cart = [];
        let productsGrid;

        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Pharmacy page loaded, starting to load medicines...');
            
            // Initialize DOM elements
            productsGrid = document.getElementById('productsGrid');
            
            console.log('Global variables initialized:', { medicines, filteredMedicines, cart, productsGrid });
            
            if (!Utils.isLoggedIn()) {
                Utils.showError('Please login first');
                window.location.href = '../userauth/login.html';
                return;
            }

            // Test API directly
            testMedicineAPI();
            
            // Load medicines from API
            loadMedicines().then(() => {
                console.log('Medicines loaded successfully');
                updateCartCount();
            }).catch(error => {
                console.error('Failed to load medicines:', error);
                // Show error message to user
                if (productsGrid) {
                    productsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #48ADE7;">
                            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                            <h3>Failed to load medicines</h3>
                            <p>Error: ${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #004AAD; color: white; border: none; border-radius: 5px; cursor: pointer;">Retry</button>
                        </div>
                    `;
                }
            });
        });

        // Load medicines from API
        async function loadMedicines() {
            try {
                console.log('Loading medicines from API...');
                const response = await API.getMedicines();
                console.log('API Response:', response);
                
                if (!response || response.length === 0) {
                    console.log('No medicines returned from API, using default medicines');
                    throw new Error('No medicines available');
                }
                
                // Map API data to expected format
                medicines = response.map(medicine => ({
                    id: medicine.id,
                    name: medicine.name,
                    generic: medicine.name, // Use name as generic since API doesn't have generic field
                    price: parseFloat(medicine.price),
                    unit: "per unit", // Default unit since API doesn't have unit field
                    category: "general", // Default category
                    prescription: "otc", // Default prescription status
                    stock: medicine.stock > 0 ? "in-stock" : "out-of-stock",
                    stockCount: medicine.stock,
                    description: medicine.description,
                    manufacturer: "Generic", // Default manufacturer
                    image: "https://images.unsplash.com/photo-1584017911766-d451b3d0e843?w=300&h=300&fit=crop&crop=center" // Default image
                }));
                console.log('Medicines mapped:', medicines);
                filteredMedicines = [...medicines];
                console.log('Filtered medicines:', filteredMedicines);
                renderProducts();
                return Promise.resolve(); // Return resolved promise
            } catch (error) {
                console.error('Error loading medicines:', error);
                // Use default medicines if API fails
                console.log('Using fallback medicines...');
                medicines = [
            {
                id: 1,
                name: "Paracetamol 500mg",
                generic: "Acetaminophen",
                price: 5.99,
                unit: "per 20 tablets",
                category: "pain-relief",
                prescription: "otc",
                stock: "in-stock",
                stockCount: 50,
                description: "Pain relief and fever reducer. Safe for adults and children over 6 years.",
                manufacturer: "Generic Pharma",
                image: "https://images.unsplash.com/photo-1584017911766-d451b3d0e843?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 2,
                name: "Amoxicillin 250mg",
                generic: "Amoxicillin Trihydrate",
                price: 12.50,
                unit: "per 21 capsules",
                category: "antibiotics",
                prescription: "required",
                stock: "in-stock",
                stockCount: 30,
                description: "Broad-spectrum antibiotic for bacterial infections",
                manufacturer: "MedLife Sciences",
                image: "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 3,
                name: "Vitamin D3 1000IU",
                generic: "Cholecalciferol",
                price: 8.75,
                unit: "per 30 tablets",
                category: "vitamins",
                prescription: "otc",
                stock: "low-stock",
                stockCount: 8,
                description: "Essential vitamin D supplement for bone health",
                manufacturer: "VitaHealth",
                image: "https://images.unsplash.com/photo-1550572017-edd951aa8ca6?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 4,
                name: "Metformin 500mg",
                generic: "Metformin HCl",
                price: 15.20,
                unit: "per 30 tablets",
                category: "diabetes",
                prescription: "required",
                stock: "in-stock",
                stockCount: 25,
                description: "First-line treatment for type 2 diabetes",
                manufacturer: "DiabeCare",
                image: "https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 5,
                name: "Lisinopril 10mg",
                generic: "Lisinopril",
                price: 18.99,
                unit: "per 30 tablets",
                category: "heart",
                prescription: "required",
                stock: "in-stock",
                stockCount: 40,
                description: "ACE inhibitor for high blood pressure and heart failure",
                manufacturer: "CardioMed",
                image: "https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 6,
                name: "Hydrocortisone Cream 1%",
                generic: "Hydrocortisone",
                price: 6.45,
                unit: "per 30g tube",
                category: "skin",
                prescription: "otc",
                stock: "in-stock",
                stockCount: 15,
                description: "Topical corticosteroid for skin inflammation and itching",
                manufacturer: "DermaCare",
                image: "https://images.unsplash.com/photo-1556228720-195a672e8a03?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 7,
                name: "Salbutamol Inhaler 100mcg",
                generic: "Salbutamol Sulfate",
                price: 22.30,
                unit: "per inhaler (200 doses)",
                category: "respiratory",
                prescription: "required",
                stock: "low-stock",
                stockCount: 5,
                description: "Fast-acting bronchodilator for asthma and COPD",
                manufacturer: "RespiroPharma",
                image: "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 8,
                name: "Ibuprofen 400mg",
                generic: "Ibuprofen",
                price: 7.25,
                unit: "per 24 tablets",
                category: "pain-relief",
                prescription: "otc",
                stock: "in-stock",
                stockCount: 60,
                description: "NSAID for pain, inflammation, and fever",
                manufacturer: "PainFree Labs",
                image: "https://images.unsplash.com/photo-1584017911766-d451b3d0e843?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 9,
                name: "Omeprazole 20mg",
                generic: "Omeprazole",
                price: 13.80,
                unit: "per 14 capsules",
                category: "digestive",
                prescription: "otc",
                stock: "out-of-stock",
                stockCount: 0,
                description: "Proton pump inhibitor for acid reflux and ulcers",
                manufacturer: "GastroHealth",
                image: "https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 10,
                name: "Complete Multivitamin",
                generic: "Mixed Vitamins & Minerals",
                price: 11.50,
                unit: "per 60 tablets",
                category: "vitamins",
                prescription: "otc",
                stock: "in-stock",
                stockCount: 35,
                description: "Comprehensive daily multivitamin with essential nutrients",
                manufacturer: "NutriMax",
                image: "https://images.unsplash.com/photo-1550572017-edd951aa8ca6?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 11,
                name: "Cetirizine 10mg",
                generic: "Cetirizine Hydrochloride",
                price: 9.99,
                unit: "per 30 tablets",
                category: "allergies",
                prescription: "otc",
                stock: "in-stock",
                stockCount: 45,
                description: "24-hour allergy relief antihistamine",
                manufacturer: "AllerFree",
                image: "https://images.unsplash.com/photo-1584017911766-d451b3d0e843?w=300&h=300&fit=crop&crop=center"
            },
            {
                id: 12,
                name: "Insulin Glargine 100U/ml",
                generic: "Insulin Glargine",
                price: 65.00,
                unit: "per 10ml vial",
                category: "diabetes",
                prescription: "required",
                stock: "in-stock",
                stockCount: 12,
                description: "Long-acting insulin for diabetes management",
                manufacturer: "EndoMed",
                image: "https://images.unsplash.com/photo-1556228720-195a672e8a03?w=300&h=300&fit=crop&crop=center"
            }
        ];
        filteredMedicines = [...medicines];
        renderProducts();
        return Promise.resolve(); // Return resolved promise for fallback
        }
        }

        // Global variables are already declared above
        let currentBuyNowItem = null;

        function goBack() {
            window.location.href = '../dashboard/dashboard.html';
        }

        function renderProducts() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';

            console.log('renderProducts called');
            console.log('medicines:', medicines);
            console.log('filteredMedicines:', filteredMedicines);
            console.log('productsGrid element:', productsGrid);

            // Initialize filteredMedicines if not set
            if (!filteredMedicines || filteredMedicines.length === 0) {
                filteredMedicines = medicines || [];
                console.log('Initialized filteredMedicines:', filteredMedicines);
            }

            if (filteredMedicines.length === 0) {
                console.log('No medicines to display, showing empty state');
                productsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #48ADE7;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🔍</div>
                        <h3>No medicines found</h3>
                        <p>Try adjusting your search or filter criteria</p>
                    </div>
                `;
                return;
            }

            console.log('About to render', filteredMedicines.length, 'medicines');
            productsGrid.innerHTML = ''; // Clear existing content

            filteredMedicines.forEach(medicine => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                const stockBadgeClass = medicine.stock === 'in-stock' ? 'in-stock' : 
                                       medicine.stock === 'low-stock' ? 'low-stock' : 'out-of-stock';
                const stockText = medicine.stock === 'in-stock' ? `In Stock (${medicine.stockCount})` :
                                 medicine.stock === 'low-stock' ? `Low Stock (${medicine.stockCount})` : 'Out of Stock';

                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${medicine.image}" alt="${medicine.name}" class="medicine-img" loading="lazy">
                        <div class="stock-badge ${stockBadgeClass}">${stockText}</div>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${medicine.name}</div>
                        <div class="product-generic">${medicine.generic}</div>
                        ${medicine.prescription === 'required' ? '<div class="prescription-required">Prescription Required</div>' : ''}
                        <div class="product-details">
                            <div class="product-price">${medicine.price}</div>
                            <div class="product-unit">${medicine.unit}</div>
                        </div>
                        <div class="product-actions">
                            <div class="quantity-selector">
                                <button class="quantity-btn" onclick="changeQuantity(${medicine.id}, -1)">-</button>
                                <input type="number" class="quantity-input" id="qty-${medicine.id}" value="1" min="1" max="${medicine.stockCount}">
                                <button class="quantity-btn" onclick="changeQuantity(${medicine.id}, 1)">+</button>
                            </div>
                            <button class="add-to-cart" onclick="addToCart(${medicine.id})" ${medicine.stock === 'out-of-stock' ? 'disabled' : ''}>
                                ${medicine.stock === 'out-of-stock' ? 'Out of Stock' : 'Add to Cart'}
                            </button>
                            <button class="buy-now" onclick="buyNow(${medicine.id})" ${medicine.stock === 'out-of-stock' ? 'disabled' : ''}>
                                ${medicine.stock === 'out-of-stock' ? 'Unavailable' : 'Buy Now'}
                            </button>
                        </div>
                    </div>
                `;
                
                productsGrid.appendChild(productCard);
            });
        }

        function changeQuantity(medicineId, change) {
            const quantityInput = document.getElementById(`qty-${medicineId}`);
            const medicine = medicines.find(m => m.id === medicineId);
            let newQuantity = parseInt(quantityInput.value) + change;
            
            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > medicine.stockCount) newQuantity = medicine.stockCount;
            
            quantityInput.value = newQuantity;
        }

        function addToCart(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            const quantity = parseInt(document.getElementById(`qty-${medicineId}`).value);
            
            const existingItem = cart.find(item => item.id === medicineId);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    ...medicine,
                    quantity: quantity
                });
            }
            
            updateCartCount();
            
            // Show success feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'Added!';
            button.style.background = '#28a745';
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '#004AAD';
            }, 1500);
            
            // Reset quantity to 1
            document.getElementById(`qty-${medicineId}`).value = 1;
        }

        function buyNow(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            const quantity = parseInt(document.getElementById(`qty-${medicineId}`).value);
            
            currentBuyNowItem = {
                ...medicine,
                quantity: quantity
            };
            
            openBuyNowModal();
        }

        function openBuyNowModal() {
            const modal = document.getElementById('buyNowModal');
            const buyNowItem = document.getElementById('buyNowItem');
            
            if (currentBuyNowItem) {
                const total = (currentBuyNowItem.price * currentBuyNowItem.quantity).toFixed(2);
                
                buyNowItem.innerHTML = `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            <img src="${currentBuyNowItem.image}" alt="${currentBuyNowItem.name}">
                        </div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${currentBuyNowItem.name}</div>
                            <div class="cart-item-price">${currentBuyNowItem.price} ${currentBuyNowItem.unit}</div>
                            <div style="margin-top: 5px; color: #48ADE7; font-size: 12px;">
                                Quantity: ${currentBuyNowItem.quantity} | Total: ${total}
                            </div>
                        </div>
                    </div>
                    <div class="total-amount">Total: ${total}</div>
                `;
            }
            
            modal.style.display = 'block';
        }

        function closeBuyNowModal() {
            document.getElementById('buyNowModal').style.display = 'none';
            currentBuyNowItem = null;
        }

        function confirmQuickPurchase() {
            if (!currentBuyNowItem) return;
            
            const total = (currentBuyNowItem.price * currentBuyNowItem.quantity).toFixed(2);
            const orderNumber = 'QP' + Date.now().toString().slice(-6);
            
            alert(`Quick Purchase Confirmed!
            
Order Details:
• ${currentBuyNowItem.name}
• Quantity: ${currentBuyNowItem.quantity}
• Total: ${total}
• Order Number: #${orderNumber}

Payment processed successfully!
Please collect your medicine from the pharmacy counter.`);
            
            closeBuyNowModal();
            // Reset quantity
            document.getElementById(`qty-${currentBuyNowItem.id}`).value = 1;
        }

        function confirmCashPurchase() {
            if (!currentBuyNowItem) return;
            
            const total = (currentBuyNowItem.price * currentBuyNowItem.quantity).toFixed(2);
            const orderNumber = 'CP' + Date.now().toString().slice(-6);
            
            alert(`Cash Payment Order Created!
            
Order Details:
• ${currentBuyNowItem.name}
• Quantity: ${currentBuyNowItem.quantity}
• Total: ${total}
• Order Number: #${orderNumber}

Please proceed to the pharmacy counter with this order number to complete your cash payment and collect your medicine.`);
            
            closeBuyNowModal();
            // Reset quantity
            document.getElementById(`qty-${currentBuyNowItem.id}`).value = 1;
        }

        function updateCartCount() {
            const cartCount = document.getElementById('cartCount');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
        }

        function removeFromCart(medicineId) {
            cart = cart.filter(item => item.id !== medicineId);
            updateCartCount();
            renderCartItems();
        }

        function updateCartQuantity(medicineId, newQuantity) {
            const item = cart.find(item => item.id === medicineId);
            if (item) {
                if (newQuantity <= 0) {
                    removeFromCart(medicineId);
                } else if (newQuantity <= item.stockCount) {
                    item.quantity = newQuantity;
                    renderCartItems();
                }
            }
        }

        function renderCartItems() {
            const cartItems = document.getElementById('cartItems');
            const cartSummary = document.getElementById('cartSummary');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div style="text-align: center; color: #48ADE7; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">🛒</div>
                        <h3 style="margin-bottom: 10px;">Your cart is empty</h3>
                        <p>Add some medicines to get started!</p>
                    </div>
                `;
                cartSummary.style.display = 'none';
                return;
            }
            
            cartItems.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${item.price} ${item.unit}</div>
                        <div style="margin-top: 5px; color: #48ADE7; font-size: 12px;">
                            Subtotal: ${itemTotal.toFixed(2)}
                        </div>
                    </div>
                    <div class="cart-item-actions">
                        <div class="quantity-selector">
                            <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" 
                                   onchange="updateCartQuantity(${item.id}, parseInt(this.value))" 
                                   min="1" max="${item.stockCount}">
                            <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        </div>
                        <button class="remove-item" onclick="removeFromCart(${item.id})">Remove</button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            document.getElementById('totalAmount').textContent = `Total: ${total.toFixed(2)}`;
            cartSummary.style.display = 'block';
        }

        function openCartModal() {
            document.getElementById('cartModal').style.display = 'block';
            renderCartItems();
        }

        function closeCartModal() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function proceedToCheckout() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const orderNumber = 'CO' + Date.now().toString().slice(-6);
            
            const orderDetails = cart.map(item => 
                `• ${item.name} (Qty: ${item.quantity}) - ${(item.price * item.quantity).toFixed(2)}`
            ).join('\n');
            
            const confirmMessage = `Checkout Confirmation
            
Order Summary:
${orderDetails}

Total Items: ${itemCount}
Total Amount: ${total.toFixed(2)}
Order Number: #${orderNumber}

Proceed with online payment?`;
            
            if (confirm(confirmMessage)) {
                alert(`Payment Successful!

Your order #${orderNumber} has been confirmed!
Total paid: ${total.toFixed(2)}

Your medicines will be prepared for pickup.
Please visit the pharmacy counter with your order number.

Thank you for choosing Leeyana Pharmacy!`);
                
                // Clear cart after successful order
                cart.length = 0;
                updateCartCount();
                closeCartModal();
            }
        }

        function proceedToCashPayment() {
            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const orderNumber = 'CP' + Date.now().toString().slice(-6);
            
            const orderDetails = cart.map(item => 
                `• ${item.name} (Qty: ${item.quantity}) - ${(item.price * item.quantity).toFixed(2)}`
            ).join('\n');
            
            const confirmMessage = `Cash Payment Order
            
Order Summary:
${orderDetails}

Total Items: ${itemCount}
Total Amount: ${total.toFixed(2)}

Create cash payment order?`;
            
            if (confirm(confirmMessage)) {
                alert(`Cash Payment Order Created!

Order Number: #${orderNumber}
Total Amount: ${total.toFixed(2)}

Please proceed to the pharmacy counter with this order number to:
1. Complete your cash payment
2. Collect your medicines

Your order will be held for 24 hours.
Thank you for choosing Leeyana Pharmacy!`);
                
                // Clear cart after successful order
                cart.length = 0;
                updateCartCount();
                closeCartModal();
            }
        }

        function openRequestModal() {
            document.getElementById('requestModal').style.display = 'block';
        }

        function closeRequestModal() {
            document.getElementById('requestModal').style.display = 'none';
        }

        function applyFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const prescriptionFilter = document.getElementById('prescriptionFilter').value;
            const priceFilter = document.getElementById('priceFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Initialize filteredMedicines with all medicines if not already set
            if (!medicines || medicines.length === 0) {
                filteredMedicines = [];
            } else {
                filteredMedicines = medicines.filter(medicine => {
                // Category filter
                if (categoryFilter && medicine.category !== categoryFilter) return false;
                
                // Prescription filter
                if (prescriptionFilter === 'required' && medicine.prescription !== 'required') return false;
                if (prescriptionFilter === 'otc' && medicine.prescription !== 'otc') return false;
                
                // Price filter
                if (priceFilter) {
                    const [min, max] = priceFilter.split('-').map(p => p === '' ? Infinity : parseFloat(p.replace('+', '')));
                    if (priceFilter.includes('+')) {
                        if (medicine.price < min) return false;
                    } else {
                        if (medicine.price < min || medicine.price > max) return false;
                    }
                }
                
                // Stock filter
                if (stockFilter && medicine.stock !== stockFilter) return false;
                
                // Search filter
                if (searchTerm && 
                    !medicine.name.toLowerCase().includes(searchTerm) && 
                    !medicine.generic.toLowerCase().includes(searchTerm) &&
                    !medicine.description.toLowerCase().includes(searchTerm)) return false;
                
                return true;
                });
            }

            renderProducts();
        }

        // Event listeners
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('prescriptionFilter').addEventListener('change', applyFilters);
        document.getElementById('priceFilter').addEventListener('change', applyFilters);
        document.getElementById('stockFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);

        // Request form submission
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.querySelector('#requestForm button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            
            try {
                const formData = {
                    patient_name: document.getElementById('patientName').value,
                    contact_number: document.getElementById('contactNumber').value,
                    medicine_name: document.getElementById('medicineName').value,
                    dosage: document.getElementById('dosage').value,
                    quantity: document.getElementById('quantity').value,
                    urgency: document.getElementById('urgency').value,
                    form_type: document.getElementById('formType').value,
                    doctor_name: document.getElementById('doctorName').value,
                    medical_condition: document.getElementById('medicalCondition').value,
                    patient_age: document.getElementById('patientAge').value,
                    allergies: document.getElementById('allergies').value,
                    additional_notes: document.getElementById('additionalNotes').value
                };
                
                await API.requestMedicine(formData);
                
                Utils.showSuccess('Medicine request submitted successfully! Our pharmacy team will contact you within 24 hours.');
                
                // Reset form
                document.getElementById('requestForm').reset();
                closeRequestModal();
                
            } catch (error) {
                Utils.showError(error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit Request';
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const requestModal = document.getElementById('requestModal');
            const cartModal = document.getElementById('cartModal');
            const buyNowModal = document.getElementById('buyNowModal');
            
            if (event.target === requestModal) {
                closeRequestModal();
            }
            if (event.target === cartModal) {
                closeCartModal();
            }
            if (event.target === buyNowModal) {
                closeBuyNowModal();
            }
        });

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000/api';

        // API Helper Functions
        class API {
            static async request(endpoint, options = {}) {
                const url = `${API_BASE_URL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                console.log('Making API request to:', url);
                console.log('Request config:', config);

                try {
                    const response = await fetch(url, config);
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        console.log('Response data:', data);
                        if (!response.ok) {
                            throw new Error(data.error || data.detail || `API request failed: ${response.status}`);
                        }
                        return data;
                    } else {
                        const text = await response.text();
                        console.log('Non-JSON response:', text);
                        throw new Error('Server returned invalid response');
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Cannot connect to server. Please make sure the server is running on http://localhost:8000');
                    }
                    throw error;
                }
            }

            static async getMedicines() {
                return this.request('/pharmacy/medicines/', {
                    method: 'GET'
                });
            }

            static async requestMedicine(medicineData) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('Please login first to request medicines');
                }
                return this.request('/pharmacy/request/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(medicineData)
                });
            }

            static async uploadPrescription(formData) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('Please login first to upload prescriptions');
                }
                return this.request('/pharmacy/prescriptions/upload/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
            }
        }

        // Utility Functions
        const Utils = {
            setToken(token) {
                localStorage.setItem('access_token', token);
            },

            getToken() {
                return localStorage.getItem('access_token');
            },

            removeToken() {
                localStorage.removeItem('access_token');
            },

            isLoggedIn() {
                return !!localStorage.getItem('access_token');
            },

            showSuccess(message) {
                alert('Success: ' + message);
            },

            showError(message) {
                alert('Error: ' + message);
            },

            navigateTo(url) {
                window.location.href = url;
            },

            logout() {
                this.removeToken();
                this.navigateTo('../home.html');
            }
        };

        // Initialize page - consolidated into the first DOMContentLoaded listener above

        // Test function to debug API
        async function testMedicineAPI() {
            try {
                console.log('Testing medicine API directly...');
                const response = await fetch('http://localhost:8000/api/pharmacy/medicines/');
                console.log('Direct fetch response status:', response.status);
                console.log('Direct fetch response headers:', response.headers);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Direct fetch data:', data);
                    console.log('Number of medicines:', data.length);
                } else {
                    console.log('Direct fetch failed:', response.status);
                }
            } catch (error) {
                console.error('Direct fetch error:', error);
            }
        }

        // ESC key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRequestModal();
                closeCartModal();
                closeBuyNowModal();
            }
        });
    </script>
</body>
</html>